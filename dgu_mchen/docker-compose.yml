networks:
  opsci-net:
    driver: bridge

volumes:
  postgres_data:

services:
  strapi:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: strapi
    env_file:
      - .env
    depends_on:
      - postgres-container
      - kafka
    ports:
      - "1337:1337"
    networks:
      - opsci-net
    volumes:
      - ./dgu_mchen:/opt/app/src/api
    restart: unless-stopped

  postgres-container:
    image: postgres:latest
    container_name: postgres-container
    environment:
      POSTGRES_DB: strapi
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dgumchen
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      retries: 5
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - opsci-net
    restart: unless-stopped

  zookeeper:
    image: wurstmeister/zookeeper:latest
    container_name: zookeeper
    ports:
      - "2181:2181"
    networks:
      - opsci-net
    restart: unless-stopped

  kafka:
    image: wurstmeister/kafka:2.11-1.1.1
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"
    networks:
      - opsci-net
    restart: unless-stopped
  event-producer:
    build:
      context: ./event-producer
    container_name: event-producer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      TOPIC: event
      ERROR_TOPIC: errors
      FILE_NAME: /opt/app/events.csv
    volumes:
        - ./event-producer/products.csv:/opt/app/events.csv
    depends_on:
      - kafka
    networks:
      - opsci-net
    restart: unless-stopped

  event-consumer:
    build:
      context: ./event-consumer
    container_name: event-consumer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      STRAPI_URL: http://strapi:1337
      STRAPI_TOKEN: bdc00138f6bc034f21a285f0a2103b17d7c15f93648fb80544624b0fbf79e3434d048ccc1a50519c2e60c3fad6b4729662eab931beacab54432d5c2f3f86adf0982a8451c9a7863edf61cd6eccb8968eb7b2cf5f178c353cc1de0c46480e5b553b4bdfb017d8318b525f066b6395956c2088f153970cc6c933ec7006aed90c4b
      TOPIC: event
      BEGINNING: "false"
      ERROR_TOPIC: errors
    depends_on:
      - kafka
      - strapi
    networks:
      - opsci-net
    restart: unless-stopped

  product-producer:
    build:
      context: ./product-producer
    container_name: product-producer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      TOPIC: product
      ERROR_TOPIC: errors
      FILE_NAME: /opt/app/products.csv
    volumes:
        - ./product-producer/products.csv:/opt/app/products.csv
    depends_on:
      - kafka
    networks:
      - opsci-net
    restart: unless-stopped

  product-consumer:
    build:
      context: ./product-consumer
    container_name: product-consumer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      STRAPI_URL: http://strapi:1337
      STRAPI_TOKEN: bdc00138f6bc034f21a285f0a2103b17d7c15f93648fb80544624b0fbf79e3434d048ccc1a50519c2e60c3fad6b4729662eab931beacab54432d5c2f3f86adf0982a8451c9a7863edf61cd6eccb8968eb7b2cf5f178c353cc1de0c46480e5b553b4bdfb017d8318b525f066b6395956c2088f153970cc6c933ec7006aed90c4b
      TOPIC: product
      BEGINNING: "false"
      ERROR_TOPIC: errors
    depends_on:
      - kafka
      - strapi
    networks:
      - opsci-net
    restart: unless-stopped

  stock-producer:
    build:
      context: ./stock-producer
    container_name: stock-producer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      TOPIC: stock
      ERROR_TOPIC: errors
      FILE_NAME: /opt/app/stocks.csv
    volumes:
        - ./stock-producer/products.csv:/opt/app/stocks.csv
    depends_on:
      - kafka
    networks:
      - opsci-net


  stock-consumer:
    build:
      context: ./stock-consumer
    container_name: stock-consumer
    env_file:
      - .env
    environment:
      BROKER_1: kafka:9092
      BROKER_2: kafka:9092
      BROKER_3: kafka:9092
      STRAPI_URL: http://strapi:1337
      STRAPI_TOKEN: bdc00138f6bc034f21a285f0a2103b17d7c15f93648fb80544624b0fbf79e3434d048ccc1a50519c2e60c3fad6b4729662eab931beacab54432d5c2f3f86adf0982a8451c9a7863edf61cd6eccb8968eb7b2cf5f178c353cc1de0c46480e5b553b4bdfb017d8318b525f066b6395956c2088f153970cc6c933ec7006aed90c4b
      TOPIC: stock
      BEGINNING: "false"
      ERROR_TOPIC: errors
    depends_on:
      - kafka
      - strapi
    networks:
      - opsci-net
    restart: unless-stopped

